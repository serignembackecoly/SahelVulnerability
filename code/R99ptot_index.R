# R script to calculate R99ptot :  annual total precipitation due to days
# where the daily preciptation exceeds the 99th percentile of wet-day distrubt

# Libraries
library(tidyverse)

# Load data
combined_data <- read.csv2("data/daily_precip_provinces.csv") %>% 
  rename(date = year) %>% 
  mutate(year = year(date), .before = 1)

# Create the function for consecutive wet days
calculate_r99ptot <- function(data) {
  # initialiation
  r99p <- quantile(data[data>=1.0], probs = 0.99, na.rm = TRUE)
  r99ptot <- sum(data[data>=r99p], na.rm = TRUE)
  return(r99ptot)
}

# An empty data frame to save the r99ptot results
annual_r99ptot <- data.frame(year = unique(combined_data$year))

# Apply the function to each group of year and province
for (col_index in 3:ncol(combined_data)) {
  col_name <- colnames(combined_data)[col_index]
  annual_r99ptot[[col_name]] <- rep(NA, nrow(annual_r99ptot))
  
  for (i in 1:nrow(annual_r99ptot)) {
    year <- annual_r99ptot$year[i]
    annual_r99ptot[[col_name]][i] <- calculate_r99ptot(combined_data[[col_name]][combined_data$year == year])
  } 
}


## Visualisation
# Make a long data frame
df <- annual_r99ptot %>% 
  pivot_longer(cols = -1, names_to = "provinces", values_to = "value")

# Calculate trend direction for each province
trend_data <- df %>%
  group_by(provinces) %>%
  do({
    model <- lm(value ~ year, data = .)
    trend <- coef(model)[["year"]]  # Slope of the linear model
    data.frame(trend = trend)
  }) %>%
  ungroup() %>%
  mutate(trend_color = ifelse(trend > 0, "Increasing", "Decreasing"))

# Count number of provinces with each trend
trend_counts <- trend_data %>%
  group_by(trend_color) %>%
  summarise(count = n())

# Add the trend count information to the legend labels
legend_labels <- trend_counts %>%
  mutate(label = paste(trend_color, " (", count, " provinces)", sep = "")) %>%
  pull(label)

# Merge trend data with the original data
df_r99ptot <- df %>%
  left_join(trend_data, by = "provinces") 

# Do the graphic
df_r99ptot %>% 
  ggplot(aes(x = year, y = value, group = provinces)) +
  geom_line(linewidth = 1, show.legend = F) +
  geom_smooth(method = "lm", se = TRUE, aes(group = provinces, color = trend_color)) +  # Add smooth trend line
  labs(x = NULL,
       y = "Annual precipitation of days >= 99 percentile (mm)",
       color = "Trend Direction") +
  scale_color_manual(values = c("Increasing" = "blue", "Decreasing" = "red"),
                     labels = legend_labels) +
  scale_x_continuous(breaks = seq(1980,2010,5)) +
  theme_test() + # classic light test
  facet_wrap(~provinces, scales = "free_y") +
  theme(
    axis.text = element_text(color = "black"),
    axis.text.x = element_text(angle = 90),
    axis.ticks.length = unit(-0.10, "cm"),
    strip.text = element_text(face = "bold", size = 12),
    axis.title = element_text(face = "bold", size = 14),
    legend.position = "inside",
    legend.position.inside = c(0.65, 0.05),
    legend.box = "horizontal",
    legend.direction = "horizontal",
    legend.title.position = "top",
    legend.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.text = element_text(colour = "black", size = 12)
  )
ggsave("figures/annual_rainfall_r99ptot.png", height = 12, width = 16, dpi = 400)
