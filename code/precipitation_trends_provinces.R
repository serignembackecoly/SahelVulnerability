# Library
library(glue)

# Load the data
bfa_shp <- readOGR(paste0("data/Burkina/BFA_adm1.shp"), verbose=F)

prec_an <- read.csv2("data/prec_annual_provinces.csv")

bfa_shp@data[,20:61] <- prec_an[,-1]
names(bfa_shp@data)[20:61] <- paste0("year_", c(1981:2022))

yr <- 1990

png(filename = "figures/precipitation_all_provinces.png", type = "cairo",
    width = 8, height = 6, units = "in", res = 300)
spplot(bfa_shp, paste0("year_", c(1981:2022)),
       col.regions= rev(terrain.colors(20)))
dev.off()

dat <- melt(bfa_shp@data[,c(5,20:61)], id.vars = "NAME_1")
names(dat) <- c("provinces", "year", "precip")
dat$year <- as.numeric(substring(dat$year, 6,9))

ggplot(data=dat, aes(x=year, y=precip)) +
  geom_line(linewidth=0.7, color = "blue") + 
  geom_point(size=1) +
  labs(x=NULL, y="precipitation (mm)") +
  facet_wrap(~provinces, scales="free") +
  ggthemes::theme_calc()

ggsave("figures/evolution_precipititation_provincest.png",
       height = 12, width = 19, dpi = 600)
  # Significant trends ?
results <- data.frame(bfa = bfa_shp@data[,5], result = NA, pvalue = NA)
prec_an_no_name <- prec_an[,-1]



# Vectorized Mann-Kendall test
test_results <- apply(prec_an_no_name, 1, MannKendall)
results$pvalue <- sapply(test_results, function(x) x$sl[1])
results$result <- ifelse(results$pvalue < 0.05, "significant trend", "no significant trend")

results