# Monthly precipitation calculation

# Librairies
library(R.utils)
library(raster)
library(exactextractr)
library(rgdal)
library(reshape2)
library(dplyr)
library(ggplot2)
library(viridis)
library(pals)
library(lubridate)
library(Kendall)
library(stringr)
library(doParallel)
library(foreach)
library(lattice)
library(rasterVis)
library(terra)

# dd <- rast(c("E:/Chirps_daily/BFA/chirps_BFA_1981.nc"))
# 
# mean_month <- tapp(dd, "month", sum)
# 
# plot(mean_month)

# All netcdf files in my repository
dir <- "E:/Chirps_daily/BFA/"
allncfiles <- list.files("E:/Chirps_daily/BFA/", pattern = ".nc$")
years <- as.numeric(substring(allncfiles, 12, 15))

## initialize cluster
UseCores <- detectCores()-1
cl <- makeCluster(UseCores)
registerDoParallel(cl)

## iterate over each year
foreach(y=1:length(years)) %dopar%
  {
    ## load packages
    library(R.utils)
    library(terra)

    ## identify which gz-files correspond to year y
    ncfiles_sel <- allncfiles[which(substring(allncfiles, 12, 15) == years[y])]
    
    ## import TIFF files as raster stack
    data <- rast(paste0(dir,ncfiles_sel))
    
    ## calculate sum of daily precipitation rasters for each month
    data_sum <- tapp(data, "month", sum)
    
    ## export raster as TIFF file
    terra::writeRaster(data_sum, paste0("data/monthly_sums/", years[y], ".tif"), overwrite=TRUE)
  }
stopCluster(cl)

# Load the monthly data
monthly_sums <- rast(list.files("data/monthly_sums/", full.names=T,
                                 pattern = ".tif$"))
# Perfom the mean all over the years
monthly_mean_sums <- tapp(monthly_sums, 1:12, mean)

dolf <- global(monthly_mean_sums, "mean", na.rm = T)
df <- data.frame(cbind(month.abb,mean = dolf)) %>% 
  mutate(m = as.numeric(mean),
         month = factor(month.abb,
                        levels = month.abb))
plot(monthly_mean_sums)

high_cells <- annual_mean > 900
coord_high_cells <- xyFromCell(annual_mean, which(values(high_cells)))
soudanian <- extract(monthly_mean_sums, coord_high_cells)
soudanian_mean <- colMeans(soudanian, na.rm = T)

low_cells <- annual_mean < 600
coord_low_cells <- xyFromCell(annual_mean, which(values(low_cells)))
sahelian <- extract(monthly_mean_sums, coord_low_cells)
sahelian_mean <- colMeans(sahelian, na.rm = T)

middle_cells <- annual_mean >= 600 & annual_mean <= 900
coord_middle_cells <- xyFromCell(annual_mean, which(values(middle_cells)))
sahelo_soudanian <- extract(monthly_mean_sums, coord_middle_cells)
sahelo_soudanian_mean <- colMeans(sahelo_soudanian, na.rm = T)
