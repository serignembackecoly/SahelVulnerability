# Build my shiny App for precipitation of each province of Burkina Faso
library(sf)
library(readr)
library(shiny)
library(leaflet)
library(dplyr)
library(htmltools)
library(htmlwidgets)

# Load the shapefile
provinces_sf <- st_read("data/Burkina/BFA_adm1.shp")
colnames(provinces_sf)[5] <- "provinces_id"
# Load the precipitation data
precipitation_data <- read.csv2("data/prec_annual_provinces.csv")
colnames(precipitation_data)[1] <- "provinces_id"
# merge data
provinces_data <- provinces_sf %>%
  left_join(precipitation_data, by = "provinces_id")


# Define UI
ui <- fluidPage(
  titlePanel("Provinces du Burkina Faso"),
  fluidRow(
    column(8, leafletOutput("map")),
    column(4,selectInput("year", "Selectionnez une année:",
                         choices = paste0(1981:2022),  # Choices for the year dropdown
                         selected = "2022"),
           htmlOutput("info"))  # Add a place to display information
  )
)
# Define Server
server <- function(input, output, session) {
  
  # Reactive expression to get selected year and clicked province info
  reactive_info <- reactive({
    # Check if a province has been clicked
    click <- input$map_shape_click
    if (is.null(click)) {
      return(NULL)
    }
    
    # Get the information for the clicked province
    province_info <- provinces_data %>%
      filter(provinces_id == click$id)  # Filter by the unique identifier
    
    # Get the selected year from the input
    selected_year <- paste0("X", input$year)
    
    # Extract the precipitation value for the selected year
    precipitation <- province_info[[selected_year]]
    
    # Return a list with the province name and precipitation
    list(
      name = province_info$provinces_id,
      precipitation = precipitation,
      year = gsub("X", "", selected_year)
    )
  })
  
  # Render the Leaflet map
  output$map <- renderLeaflet({
    leaflet(data = provinces_data) %>%
      addProviderTiles("OpenStreetMap") %>%
      addPolygons(
        color = "blue",
        weight = 1,
        opacity = 1,
        fillOpacity = 0.1,
        highlightOptions = highlightOptions(weight = 2, color = "red", fillOpacity = 0.8),
        label = ~htmlEscape(provinces_id),
                labelOptions = labelOptions(
                  direction = "auto",
                  textOnly = FALSE,
                  style = list(
                    "color" = "black",
                    "font-family" = "serif",
                    "font-weight" = "bold",
                    "font-size" = "12px"
                  )
                ),
        layerId = ~provinces_id  # Ensure you have a unique identifier for each province
      ) %>%
      setView(lng = -1.5, lat = 12.5, zoom = 6.45)
  })
  
  # Observe changes in the selected year or clicked province
  observe({
    info <- reactive_info()
    if (!is.null(info)) {
      output$info <- renderText({
        HTML(paste("Nom de la province:", "<span style='font-weight: bold;'>", info$name, "</span>", "<br>",
              "Précipitation annuelle:", "<span style='color: navy; font-weight: bold;'>", info$precipitation, " mm</span>", "<br>",
              "Température maximale:","<span style='color: red; font-weight: bold;'>", info$temp_max, "°C</span>", "<br>",
              "Température moyenne:","<span style='color: gold; font-weight: bold;'>", info$temp_moy, "°C</span>", "<br>",
              "Température minimale:", "<span style='color: green; font-weight: bold;'>", info$temp_min, "°C</span>", "<br>",
              "Production annuelle de céréales:", "<span style='font-weight: bold;'>", info$yield, "Tonnes</span>"))
      })
    }
  })
}
 

shinyApp(ui = ui, server = server)
