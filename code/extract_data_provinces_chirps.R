# Generate the data for the province of Burkina Faso
# Librairies 
library(tidyverse)
library(terra)
library(raster)
library(rgdal)
library(exactextractr)

# Load the shapefile
bfa_shp <- readOGR(paste0("data/Burkina/BFA_adm1.shp"), verbose=F)
provinces <- bfa_shp$NAME_1

# Define the years you want to process
years <- 1981:2014

# Initialize an empty list to store results for each year
results_list <- list()

# Loop through each year
for (year in years) {
  
  # Define the file path for the current year
  file_path <- paste0("E:/Chirps_daily/BFA/chirps_BFA_", year, ".nc")
  
  # Load the raster data
  chirps_year <- stack(file_path)
  
  # Extract precipitation data
  extracted <- round(exact_extract(chirps_year, bfa_shp, fun = "mean"), 2)
  
  # Remove raster object from memory
  rm(chirps_year)
  
  # Combine provinces and extracted data
  yr_data <- cbind(provinces = provinces, extracted)
  
  # Transform the data into a long format
  yr_data_long <- pivot_longer(yr_data, cols = 2:ncol(yr_data), names_to = "jour", values_to = "precipitation") 
  
  # Transform data into a wider format
  yr_data_wider <- yr_data_long %>% pivot_wider(names_from = provinces, values_from = precipitation)
  # Append the result to the list
  results_list[[as.character(year)]] <- yr_data_wider
}

# Combine all yearly data into a single data frame
combined_data <- bind_rows(results_list, .id = "year")

# Add a date column
final_daily_data <- combined_data %>% 
  mutate(year = seq(ymd("1981-01-01"), ymd("2014-12-31"), by = "day")) %>% 
  dplyr::select(-(jour))
        
# save data
write_excel_csv2(final_daily_data, "data/daily_precip_provinces.csv") # Handle UTF-8 issue
