# Calculate the etccdi consecutive dry days
# Libraries

# Load data

# Create the function for consecutive dry days
calculate_cdd <- function(data) {
  # initialiation
  cdd <- 0
  max_cdd <- 0
  
  # Calcul
  for (precip in data) {
    if (precip < 1) {
      cdd <- cdd + 1
      max_cdd <- max(max_cdd, cdd)
    } else {
      cdd <- 0
    }
    
  }
  
  return(max_cdd)
}



# An empty data frame to save the cdds
cdd_results <- data.frame(year = unique(combined_data$year))

# Apply the function to each group of year and province
for (col_index in 3:ncol(combined_data)) {
  col_name <- colnames(combined_data)[col_index]
  cdd_results[[col_name]] <- rep(NA, nrow(cdd_results))
  
  for (i in 1:nrow(cdd_results)) {
    year <- cdd_results$year[i]
    cdd_results[[col_name]][i] <- calculate_cdd(combined_data[[col_name]][combined_data$year == year])
  } 
}


# Visualisation
cdd_results %>% 
  pivot_longer(cols = -1, names_to = "provinces", values_to = "cdd") %>% 
  mutate(annee = as.numeric(year)) %>% 
  ggplot(aes(x = annee, y = cdd, group = provinces)) +
  geom_line(alpha = 0.9, show.legend = F) +  # Adjust alpha for transparency if needed
  labs(title = "Number of consecutive dry days",
       x = "Year",
       y = "cdd (days)") +
  scale_x_continuous(breaks = seq(1980,2010,5)) +
  theme_bw() +
  facet_wrap(~provinces) +
  theme(
    axis.text.x = element_text(angle = 90)
  )
