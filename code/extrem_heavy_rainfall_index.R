# R script to calculate Extremely heavy rainfall (25 mm or higher)

# Libraries
library(tidyverse)

# Load data
combined_data <- read.csv2("data/daily_precip_provinces.csv") %>% 
  rename(date = year) %>% 
  mutate(year = year(date), .before = 1)

# Create the function for consecutive wet days
calculate_r25mm <- function(data) {
  # initialiation
  r20mm_count <- sum(data >= 25.0, na.rm = TRUE)
  return(r20mm_count)
}

# An empty data frame to save the r25mm results
annual_r25mm <- data.frame(year = unique(combined_data$year))

# Apply the function to each group of year and province
for (col_index in 3:ncol(combined_data)) {
  col_name <- colnames(combined_data)[col_index]
  annual_r25mm[[col_name]] <- rep(NA, nrow(annual_r25mm))
  
  for (i in 1:nrow(annual_r25mm)) {
    year <- annual_r25mm$year[i]
    annual_r25mm[[col_name]][i] <- calculate_r25mm(combined_data[[col_name]][combined_data$year == year])
  } 
}

# Visualisation
annual_r25mm %>% 
  pivot_longer(cols = -1, names_to = "provinces", values_to = "cdd") %>% 
  ggplot(aes(x = year, y = cdd, group = provinces)) +
  geom_line(linewidth = 1, show.legend = F) +
  geom_smooth(method = "lm", se = TRUE, aes(group = provinces), color = "green") +  # Add smooth trend line
  labs(x = NULL,
       y = "Number of extremely heavy ranifall (days)") +
  scale_x_continuous(breaks = seq(1980,2010,5)) +
  theme_test() + # classic light test
  facet_wrap(~provinces, scales = "free_y") +
  theme(
    axis.text = element_text(color = "black"),
    axis.text.x = element_text(angle = 90),
    axis.ticks.length = unit(-0.10, "cm"),
    strip.text = element_text(face = "bold", size = 10),
    axis.title = element_text(face = "bold", size = 14)
  )

ggsave("figures/number_extreme_heavy_rainfall.png", height = 10, width = 15, dpi = 400)
