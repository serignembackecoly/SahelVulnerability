# Classification of precipitation in Burkina Faso with Chirps Data

# Librairies
library(R.utils)
library(raster)
library(exactextractr)
library(rgdal)
library(reshape2)
library(dplyr)
library(ggplot2)
library(viridis)
library(pals)
library(lubridate)
library(Kendall)
library(stringr)
library(doParallel)
library(foreach)
library(lattice)
library(rasterVis)

# import the data and check

bfa_shp <- readOGR(paste0("data/Burkina/BFA_adm1.shp"), verbose=F)
plot(bfa_shp)

chirps_raster <- stack("E:/Chirps_daily/chirps_1981_2014/chirps-v2.0.1981.days_p05.nc") # "E:/Chirps_daily/BFA/chirps_BFA_1981.nc"
class(chirps_raster)
# Crop the data on Burkina Faso

chirps_raster_crop <- crop(chirps_raster, bfa_shp)
chirps_raster_crop_mask <- mask(chirps_raster_crop, bfa_shp)

plot(chirps_raster_crop_mask)

chirps_sum <- sum(chirps_raster_crop_mask)

plot(chirps_sum, main="Cumulative precipitation (mm) from Jan 01 to Dec 31, 1981", col = rev(coolwarm(50)[1:25]))
plot(bfa_shp, add = T)

chirps_mean <- mean(chirps_raster_crop_mask)
plot(chirps_mean, main="Average daily precipitation (mm) between Jan 01 to Dec 31, 1981")

chirps_max <- max(chirps_raster_crop_mask)
plot(chirps_max, main="Maximum daily precipitation between Jan 01 to Jan 10, 1981")

# Rainy days
chirps_stack_2 <- chirps_raster_crop_mask

chirps_stack_2[chirps_stack_2 > 0] <- 1

rainy_days <- sum(chirps_stack_2)
plot(rainy_days, main="Number of rainy days from Jan 01 to Dec 31, 1981", col = rev(ocean.haline(10)))
plot(bfa_shp, add = T)

# Zonal statistics
province_means <- exact_extract(x=chirps_sum, y=bfa_shp, fun="mean", progress = F)
bfa_shp$precip_mean <- province_means
spplot(bfa_shp, "precip_mean", col.regions= rev(terrain.colors(20)))

province_max <- exact_extract(x=chirps_sum, y=bfa_shp, fun="max", progress = F)
bfa_shp$precip_max <- province_max
spplot(bfa_shp, "precip_max", col.regions= rev(terrain.colors(20)))

# Parralel for all the august between 1981 to 2014
years <- c(1981:2022)
days  <- str_pad(c(213:243), 2, pad="0")

dir <- "E:/Chirps_daily/" #chirps_1981_2014/chirps-v2.0.1981.days_p05.nc
## list all nc-files in the folder containing our data
allncfiles <- list.files("E:/Chirps_daily/chirps_1981_2014/", pattern = ".nc$")

## initialize cluster
UseCores <- detectCores()-1
cl <- makeCluster(UseCores)
registerDoParallel(cl)
#y = 1
## iterate over each year
foreach(y=1:length(years)) %dopar%
{
  ## load packages
  library(R.utils)
  library(raster)

  ## identify which gz-files correspond to year y
  ncfiles_sel <- allncfiles[which(substring(allncfiles, 13, 16) == years[y])]

  # ## unzip files
  # for (i in 1:length(gzfiles_sel))
  # { gunzip(filename = paste0(dir, "download/", gzfiles_sel[i]),
  #        destname = paste0(dir, "download/" , substring(gzfiles_sel[i], 1, 26) ), remove = F, overwrite = T) }
  # 
  # ## identify TIFF files
  # tiffiles_sel <- paste0(dir, "download/", substring(gzfiles_sel, 1, 26))

  ## import TIFF files as raster stack
  data <- stack(ncfiles_sel)

  ## process raster stack
  data_crop       <- crop(data, bfa_shp)
  data_crop_mask  <- mask(data_crop, bfa_shp)

  #data_crop_mask[data_crop_mask == -9999] <- NA

  ## calculate sum of daily precipitation rasters
  data_sum <- sum(data_crop_mask)

  ## export raster as TIFF file
  writeRaster(data_sum, paste0(dir, "annually_sums/", years[y], ".tif"), format="GTiff", overwrite=TRUE)

  ## delete unzipped tiff files to save memory space
  file.remove(ncfiles_sel)
}
stopCluster(cl)

annually_sums <- stack(list.files("data/Annual_precipitation_chirps/", full.names=T))
plot(annually_sums[[14:18]])
annual_mean <-mean(annually_sums)
plot(bfa_shp, add = T, col ='gray', fill = 'none')
plot(annual_mean)

zonalstats <- exact_extract(x=annually_sums, y=bfa_shp, fun="mean", progress = F)
head(zonalstats)

bfa_shp@data[,2:43] <- zonalstats
names(bfa_shp@data)[2:43] <- paste0("year_", c(1981:2022))

spplot(bfa_shp, "year_1990", col.regions= rev(terrain.colors(20)), main = "Year 1990")

# ggplot

annual_mean %>% 
  gplot() +
  geom_tile()
